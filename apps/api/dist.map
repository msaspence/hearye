{"version":3,"sources":["src/apiApp.ts","src/dev.ts","src/index.ts"],"names":[],"mappings":"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","file":"dist","sourcesContent":["import fastify, {\n  FastifyBaseLogger,\n  FastifyInstance,\n  FastifyTypeProviderDefault,\n  RawServerDefault,\n} from 'fastify'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport Debug from 'debug'\n\nconst debug = Debug('hearye:api:run')\n\nexport async function apiApp(\n  app: FastifyInstance<\n    RawServerDefault,\n    IncomingMessage,\n    ServerResponse<IncomingMessage>,\n    FastifyBaseLogger,\n    FastifyTypeProviderDefault\n  >\n) {\n  app.get('/', (req, res) => {\n    return { hello: 'world' }\n  })\n}\n","import {\n  FastifyBaseLogger,\n  FastifyInstance,\n  FastifyTypeProviderDefault,\n  RawServerDefault,\n} from 'fastify'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport { start, FastifyRestartableOptions } from '@fastify/restartable'\nimport Debug from 'debug'\nimport chokidar from 'chokidar'\nimport ConvertAnsi from 'ansi-to-html'\n\nvar convert = new ConvertAnsi()\n\nconst config = {\n  port: 8080,\n}\n\nconst debug = Debug('hearye:api:dev')\n\nasync function devApiApp(\n  app: FastifyInstance<\n    RawServerDefault,\n    IncomingMessage,\n    ServerResponse<IncomingMessage>,\n    FastifyBaseLogger,\n    FastifyTypeProviderDefault\n  >,\n  opts: FastifyRestartableOptions\n) {\n  debug('Loading app...')\n  try {\n    const { apiApp } = await require('./apiApp')\n    app.register(apiApp)\n  } catch (error: any) {\n    debug('Error while loading')\n    debug(error)\n    app.all('*', (_, res) => {\n      res.header('Content-Type', 'text/html')\n      res.status(500)\n      return `<!DOCTYPE html><html><body style=\"background: #111; font-size: 16px; color: white;\"><pre>${convert.toHtml(\n        error.stack.toString()\n      )}</pre></body></html>`\n    })\n    debug('Waiting for changes...')\n  }\n}\n\n;(async () => {\n  const { stop, restart, listen, inject } = await start({\n    protocol: 'http',\n    hostname: '127.0.0.1',\n    port: config.port,\n    app: devApiApp,\n  })\n\n  const { address, port } = await listen()\n\n  debug(`Server listening on ${address}:${port}`)\n\n  async function handleChange() {\n    debug('Change detected reloading app')\n    clearImportCache()\n    await restart()\n    debug('App restarted')\n  }\n\n  function createWatch(dir: string) {\n    const watcher = chokidar.watch(dir, {\n      awaitWriteFinish: {\n        stabilityThreshold: 50,\n        pollInterval: 100,\n      },\n    })\n    watcher.on('ready', () => {\n      debug(`Monitoring ${dir} for changes`)\n      watcher.on('all', handleChange)\n    })\n    return watcher\n  }\n\n  createWatch('./')\n})()\n\nfunction clearImportCache() {\n  Object.keys(require.cache).forEach(function (id) {\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    if (/[/\\\\]src[/\\\\]/.test(id)) delete require.cache[id]\n  })\n}\n","import { apiApp } from './apiApp'\n\nimport Fastify from 'fastify'\nconst fastify = Fastify({\n  logger: true,\n})\n\napiApp(fastify)\n"]}